---
import Layout from "@layouts/Layout.astro";
import Collapse from "@components/common/Collapse.svelte";
import SearchBar from "@components/contracts/SearchBar.astro";
import DatePicker from "@components/common/DatePicker.svelte";
import ContractsTableLoader from "@components/contracts/ContractsTableLoader.svelte";
import {
  ContractServices,
  ContractStatus,
  ContractTypes,
} from "@lib/types/contracts";
import { Locations } from "@lib/types/locations";
import "@styles/form.css";
---

<Layout title="Contratos">
  <div class="flex items-center justify-between mb-7 gap-4">
    <div
      class="flex max-md:flex-col bg-base-100 gap-4 p-2 rounded-md shadow-sm border border-zinc-300"
    >
      <label class="select min-w-[230px] max-sm:min-w-auto clear">
        <span class="label">Local</span>
        <select required form="contract-form" name="location">
          <option disabled selected hidden value="">Local</option>
          {Locations.map((l, i) => <option value={i}>{l}</option>)}
        </select>
      </label>
      <label class="select min-w-[230px] max-sm:min-w-auto clear">
        <span class="label">Contrato</span>
        <select required form="contract-form" name="service">
          <option disabled selected hidden value="">Contrato</option>
          {ContractServices.map((c, i) => <option value={i}>{c}</option>)}
        </select>
      </label>
    </div>
    <SearchBar />
  </div>

  <Collapse client:load>
    <span id="collapse-title" slot="title">Upload</span>
    <form
      slot="content"
      id="contract-form"
      class="grid grid-cols-1 sm:grid-cols-2 gap-4 p-2 rounded-sm shadow-sm"
    >
      <fieldset class="fieldset">
        <legend class="fieldset-legend">Fornecedor:</legend>
        <input
          required
          type="text"
          class="input"
          placeholder="Nome do Fornecedor"
          name="supplier"
        />
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Número de Contrato:</legend>
        <input
          required
          type="number"
          min="0"
          class="input"
          placeholder="Número de Contrato"
          name="contract-number"
        />
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Data:</legend>
        <DatePicker client:load range={false} formName="date" />
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Data Início - Fim:</legend>
        <DatePicker client:load range={true} formName="date-range" />
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Tipo:</legend>
        <select class="select" name="type" required>
          <option disabled selected hidden value="">Selecione um Tipo</option>
          {ContractTypes.map((t, i) => <option value={i}>{t}</option>)}
        </select>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Estado:</legend>
        <select class="select" name="status" required>
          <option disabled selected hidden value="">Selecione o Estado</option>
          {ContractStatus.map((s, i) => <option value={i}>{s}</option>)}
        </select>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Descrição:</legend>
        <textarea
          required
          class="textarea"
          placeholder="Descrição"
          name="description"></textarea>
      </fieldset>

      <fieldset class="fieldset">
        <legend class="fieldset-legend">Ficheiros:</legend>
        <input
          type="file"
          class="file-input"
          id="files-input"
          accept="image/*,.doc,.docx,.xls,.xlsx,.pdf"
          required
          multiple
        />
      </fieldset>

      <div class="flex justify-between sm:col-span-2">
        <button type="reset" class="btn btn-error">Limpar</button>
        <button type="submit" class="btn btn-primary">
          <span class="hidden loading loading-bars loading-md"></span>
          <span id="submit-text">Enviar</span>
        </button>
      </div>
    </form>
  </Collapse>
  <Collapse client:load>
    <span slot="title">Contratos</span>
    <div slot="content">
      <ContractsTableLoader client:load />
    </div>
  </Collapse>
</Layout>

<script>
  import { uploadContract } from "@api/utils";
  import { showAlert, AlertPosition, AlertType } from "@components/alert/alert";
  import {
    ContractServices,
    ContractStatus,
    ContractTypes,
  } from "@lib/types/contracts";
  import { Locations } from "@lib/types/locations";
  import { elementsToToggle } from "@stores/loading-stores";
  import { newContract } from "@stores/contracts-stores";
  import type { Contract } from "@lib/types/contracts";
  import {
    DMYToDate,
    getFirstDateFromRange,
    getSecondDateFromRange,
  } from "@utils/date-utils";

  document.addEventListener("astro:page-load", () => {
    if (window.location.pathname !== "/contratos/") return;

    const locationSelect = document.querySelector(
      'select[name="location"]'
    )! as HTMLSelectElement;
    const serviceSelect = document.querySelector(
      'select[name="service"]'
    )! as HTMLSelectElement;

    const title = document.getElementById("collapse-title")!;

    const filesInput = document.getElementById(
      "files-input"
    )! as HTMLInputElement;

    locationSelect.addEventListener("change", (event) => {
      if (!serviceSelect.value) return;
      // @ts-ignore
      title.innerHTML = `Upload - ${Locations[locationSelect.value]} - ${ContractServices[event.currentTarget.value]}`;
    });

    serviceSelect.addEventListener("change", (event) => {
      if (!locationSelect.value) return;
      // @ts-ignore
      title.innerHTML = `Upload - ${Locations[locationSelect.value]} - ${ContractServices[event.currentTarget.value]}`;
    });

    const selects = document.querySelectorAll(".select");
    for (let i = 2, len = selects.length; i < len; i++) {
      selects[i].addEventListener("change", (event) => {
        // @ts-ignore
        event.currentTarget.style.opacity = "1";
      });
    }

    const submitButton = document.querySelector(
      ".btn-primary"
    )! as HTMLButtonElement;
    const loadingBars = submitButton.querySelector(".loading")!;
    const submitText = submitButton.querySelector("#submit-text")!;

    elementsToToggle.set([loadingBars, submitText]);

    (
      document.getElementById("contract-form")! as HTMLFormElement
    ).addEventListener("submit", async (e) => {
      e.preventDefault();

      const form = e.currentTarget as HTMLFormElement;

      loadingBars.classList.toggle("hidden");
      submitText.classList.toggle("hidden");

      const formData = new FormData(form); // This is the form without the files

      for (let i = 0, len = filesInput.files!.length; i < len; i++) {
        const file = filesInput.files![i];
        formData.append("files", file, `${file.name}_${file.size}`);
      }

      const [ok, contractId, fileId] = await uploadContract(formData);

      loadingBars.classList.toggle("hidden");
      submitText.classList.toggle("hidden");

      if (ok) {
        setNewContract(formData, contractId, fileId);

        form.reset();
        showAlert(
          "Contrato enviado com sucesso!",
          AlertType.SUCCESS,
          AlertPosition.TOP
        );
      } else {
        showAlert(
          "Erro ao enviar o contrato. Por favor, tente novamente.",
          AlertType.ERROR,
          AlertPosition.TOP
        );
      }
    });

    function setNewContract(
      formData: FormData,
      contractId: number,
      fileId: number
    ) {
      const dateString = formData.get("date") as string;
      const date = DMYToDate(dateString);

      const dateRange = formData.get("date-range") as string;
      const [dateStartString, dateStart] = getFirstDateFromRange(dateRange);
      const [dateEndString, dateEnd] = getSecondDateFromRange(dateRange);

      const nowISO = new Date().toISOString();
      const createdAt = `${nowISO.substring(0, 10)}, ${nowISO.substring(11, 19)}`;

      const supplier = formData.get("supplier") as string;
      const __searchSupplier = supplier
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();

      const locationValue = parseInt(locationSelect.value, 10);
      const location = Locations[locationValue];
      const __searchLocation = location
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();

      const serviceValue = parseInt(serviceSelect.value, 10);
      const service = ContractServices[serviceValue];
      const __searchService = service
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "");

      const statusValue = parseInt(formData.get("status")! as string, 10);
      const status = ContractStatus[statusValue];
      const __searchStatus = status
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();

      const typeValue = parseInt(formData.get("type")! as string, 10);
      const type = ContractTypes[typeValue];
      const __searchType = type
        .normalize("NFKD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase();

      const contractNumber = formData.get("contract-number") as string;

      const contract: Contract = {
        contractNumber: contractNumber as unknown as number,
        location: location,

        service: service,
        supplier: formData.get("supplier") as string,
        date: date,
        dateStart: dateStart,
        dateEnd: dateEnd,
        type: type,
        status: status,
        description: formData.get("description") as string,
        createdAt: createdAt,
        updatedAt: createdAt,
        files: {},

        dateString: dateString,
        dateStartString: dateStartString,
        dateEndString: dateEndString,

        locationValue: locationValue,
        serviceValue: serviceValue,
        statusValue: statusValue,
        typeValue: typeValue,

        __searchSupplier: __searchSupplier,
        __searchLocation: __searchLocation,
        __searchService: __searchService,
        __searchContractNumber: contractNumber,
        __searchStatus: __searchStatus,
        __searchType: __searchType,
      };

      const files = formData.getAll("files") as File[];
      for (let i = 0, len = files.length; i < len; i++) {
        const file = files[i];
        contract.files[fileId + i] = {
          name: file.name,
          path: `media/contracts/${contractId}/${file.name}`,
          uploadedAt: createdAt,
        };
      }
      newContract.set({ id: contractId, contract: contract });
    }
  });
</script>

<style>
  @media (max-width: 40rem) {
    .label {
      display: none;
    }
  }
</style>
